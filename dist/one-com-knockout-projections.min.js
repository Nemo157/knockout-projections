/*! Knockout projections plugin - version 1.1.0-pre
------------------------------------------------------------------------------
Copyright (c) Microsoft Corporation
All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0
THIS CODE IS PROVIDED *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE, MERCHANTABLITY OR NON-INFRINGEMENT.
See the Apache Version 2.0 License for specific language governing permissions and limitations under the License.
------------------------------------------------------------------------------
*/
!function(a){"use strict";function b(a){var b=Array.prototype.slice.call(arguments,1);return b.forEach(function(b){if(b)for(var c in b)a[c]=b[c]}),a}function c(a,b,c,d,e,f,g){this.inputItem=b,this.stateArrayIndex=c,this.mappingOptions=e,this.arrayOfState=f,this.outputObservableArray=g,this.outputArray=this.outputObservableArray.peek(),this.isIncluded=null,this.suppressNotification=!1,this.outputArrayIndex=a.observable(d),this.mappedValueComputed=a.computed(this.mappingEvaluator,this),this.mappedValueComputed.subscribe(this.onMappingResultChanged,this),this.previousMappedValue=this.mappedValueComputed.peek()}function d(a,b){if(!a)return null;switch(a.status){case"added":return a.index;case"deleted":return a.index+b;default:throw new Error("Unknown diff status: "+a.status)}}function e(a,b,d,e,f,g,h,i,j){var k="number"==typeof b.moved,l=k?d[b.moved]:new c(a,b.value,e,f,g,h,i);return h.splice(e,0,l),l.isIncluded&&j.splice(f,0,l.mappedValueComputed.peek()),k&&(l.stateArrayIndex=e,l.setOutputArrayIndexSilently(f)),l}function f(a,b,c,d,e){var f=b.splice(c,1)[0];f.isIncluded&&e.splice(d,1),"number"!=typeof a.moved&&f.dispose()}function g(a,b,c){return a.stateArrayIndex=b,a.setOutputArrayIndexSilently(c),c+(a.isIncluded?1:0)}function h(a,b){for(var c={},d=0;d<a.length;d++){var e=a[d];"added"===e.status&&"number"==typeof e.moved&&(c[e.moved]=b[e.moved])}return c}function i(a,b,c){return c.length&&b[a.index]?b[a.index].outputArrayIndex.peek():c.length}function j(a,b,c,j,k,l){return b.subscribe(function(b){if(b.length){for(var m=h(b,c),n=0,o=b[0],p=0,q=o&&i(o,c,j),r=o.index;o||r<c.length;r++)if(d(o,p)===r){switch(o.status){case"added":var s=e(a,o,m,r,q,l,c,k,j);s.isIncluded&&q++,p++;break;case"deleted":f(o,c,r,q,j),p--,r--;break;default:throw new Error("Unknown diff status: "+o.status)}n++,o=b[n]}else r<c.length&&(q=g(c[r],r,q));k.valueHasMutated()}},null,"arrayChange")}function k(a,b){var d=this,e=[],f=[],g=a.observableArray(f),h=d.peek();"function"==typeof b&&(b={mapping:b});for(var i=0;i<h.length;i++){var k=h[i],l=new c(a,k,i,f.length,b,e,g),m=l.mappedValueComputed.peek();e.push(l),l.isIncluded&&f.push(m)}var n=j(a,d,e,f,g,b),o=a.computed(g).extend({trackArrayChanges:!0}),p=o.dispose;return o.dispose=function(){n.dispose(),a.utils.arrayForEach(e,function(a){a.dispose()}),p.call(this,arguments)},A(a,o),o}function l(a,b){return k.call(this,a,function(a){return b(a)?a:D})}function m(a){var b=r.Descending;return function(c,d){var e=a(c,b.create),f=a(d,b.create);Array.isArray(e)||(e=[e],f=[f]);for(var g,h,i=0;i<e.length;i+=1)if(g=e[i],h=f[i],g instanceof b){if(g.value>h.value)return-1;if(g.value<h.value)return 1}else{if(h>g)return-1;if(g>h)return 1}return 0}}function n(a,b,c){for(var d,e=-1,f=a.length;f-e>1;){d=e+f>>>1;var g=c(a[d],b);if(0>g)e=d;else if(f=d,!g)break}return f===a.length||c(a[f],b)?-f-1:f}function o(a,b,c){for(var d,e=-1,f=a.length;f-e>1;)d=e+f>>>1,c(a[d],b)<0?e=d:f=d;return f}function p(a,b,c){var d=n(a,b,c);if(0>d||a.length<=d||0!==c(a[d],b))return-1;for(var e=d;d-1>=0&&0===c(a[d-1],b);)d-=1;for(;e>=d;){if(a[d]===b)return d;d+=1}for(;d<a.length;){if(0!==c(a[d],b))return-1;if(a[d]===b)return d;d+=1}return-1}function q(a,b){var c=a.ko;this.projection=a,this.inputItem=b,this.mappedValueComputed=c.computed(this.mappingEvaluator,this),this.mappedValueComputed.subscribe(this.onMappingResultChanged,this),this.previousMappedValue=this.mappedValueComputed.peek()}function r(a,b,c){var d=this;this.ko=a,this.options=c,this.mapping=c.mapping,this.comparefn=m(this.mapping),this.outputObservable=a.observable([].concat(b.peek()).sort(this.comparefn)),this.stateItems=a.utils.arrayMap(this.outputObservable.peek(),function(a){return new q(d,a)});var e=b.subscribe(this.onStructuralChange,this,"arrayChange");this.output=a.computed(this.outputObservable).extend({trackArrayChanges:!0});var f=this.output.dispose;this.output.dispose=function(){e.dispose(),a.utils.arrayForEach(d.stateItems,function(a){a.dispose()}),f.call(this,arguments)},A(a,this.output)}function s(a,b){"function"==typeof b&&(b={mapping:b});var c=new r(a,this,b);return c.output}function t(a,b,c){var d=this;this.ko=a,this.options=c,this.outputObservable=a.observable({}),this.stateItems={},this.mapping=c.mapping;for(var e=b.peek(),f=0;f<e.length;f+=1)this.addToIndex(e[f],f);var g=b.subscribe(this.onStructuralChange,this,"arrayChange");this.output=a.computed(this.outputObservable);var h=this.output.dispose;this.output.dispose=function(){g.dispose();for(var a in d.stateItems)d.stateItems.hasOwnProperty(a)&&d.stateItems[a].dispose();h.call(this,arguments)}}function u(a,b){this.projection=a,this.inputItem=b,this.mappedValueComputed=a.ko.computed(this.mappingEvaluator,this),this.mappedValueComputed.subscribe(this.onMappingResultChanged,this),this.previousMappedValue=this.mappedValueComputed.peek()}function v(a,b,c){t.call(this,a,b,c)}function w(a,b){u.call(this,a,b)}function x(a,b){"function"==typeof b&&(b={mapping:b,unique:!1});var c=b.unique?new v(a,this,b):new t(a,this,b);return c.output}function y(a,b){"function"==typeof b&&(b={mapping:b}),b.unique=!0;var c=new v(a,this,b);return c.output}function z(a){function b(a,b){return function(){return b.apply(this,[a].concat(Array.prototype.slice.call(arguments,0)))}}a[E]={map:b(a,k),sortBy:b(a,s),indexBy:b(a,x),uniqueIndexBy:b(a,y),filter:b(a,l)}}function A(a,b){return a.utils.extend(b,a[E]),b}function B(a){a.projections={_exclusionMarker:D},z(a),A(a,a.observableArray.fn)}function C(){if("undefined"!=typeof module&&"undefined"!=typeof module.exports){var b=require("knockout");B(b),module.exports=b}else"function"==typeof define&&define.amd?define(["knockout"],B):"ko"in a&&B(a.ko)}var D={};c.prototype.dispose=function(){var a=this.mappedValueComputed();this.mappedValueComputed.dispose(),this.mappingOptions.disposeItem&&this.mappingOptions.disposeItem(a)},c.prototype.mappingEvaluator=function(){var a=this.mappingOptions.mapping(this.inputItem,this.outputArrayIndex),b=a!==D;return this.isIncluded!==b&&(null!==this.isIncluded&&this.moveSubsequentItemsBecauseInclusionStateChanged(b),this.isIncluded=b),a},c.prototype.onMappingResultChanged=function(a){a!==this.previousMappedValue&&(this.isIncluded&&this.outputArray.splice(this.outputArrayIndex.peek(),1,a),this.suppressNotification||this.outputObservableArray.valueHasMutated(),this.previousMappedValue=a)},c.prototype.moveSubsequentItemsBecauseInclusionStateChanged=function(a){var b,c,d=this.outputArrayIndex.peek();if(a)for(this.outputArray.splice(d,0,null),b=this.stateArrayIndex+1;b<this.arrayOfState.length;b++)c=this.arrayOfState[b],c.setOutputArrayIndexSilently(c.outputArrayIndex.peek()+1);else for(this.outputArray.splice(d,1),b=this.stateArrayIndex+1;b<this.arrayOfState.length;b++)c=this.arrayOfState[b],c.setOutputArrayIndexSilently(c.outputArrayIndex.peek()-1)},c.prototype.setOutputArrayIndexSilently=function(a){this.suppressNotification=!0,this.outputArrayIndex(a),this.suppressNotification=!1},q.prototype.dispose=function(){var a=this.mappedValueComputed();this.mappedValueComputed.dispose(),this.projection.options.disposeItem&&this.projection.options.disposeItem(a)},q.prototype.mappingEvaluator=function(){return this.projection.mapping(this.inputItem,r.Descending.create)},q.prototype.onMappingResultChanged=function(a){if(a!==this.previousMappedValue){var b=this.projection,c=b.outputObservable.peek(),d=b.stateItems,e=p(d,this,m(function(a){return a.previousMappedValue}));c.splice(e,1),d.splice(e,1);var f=o(c,this.inputItem,b.comparefn);c.splice(f,0,this.inputItem),d.splice(f,0,this),this.previousMappedValue=a}},r.Descending=function(a){this.value=a},r.Descending.create=function(a){return new r.Descending(a)},r.prototype.onStructuralChange=function(a){if(a.length){var b=this,c=this.ko,d=[],e=[];c.utils.arrayForEach(a,function(a){if("number"!=typeof a.moved)switch(a.status){case"added":d.push(a);break;case"deleted":e.push(a)}});var f=this.outputObservable.peek();c.utils.arrayForEach(e,function(a){var c=p(f,a.value,b.comparefn);-1!==c&&(f.splice(c,1),b.stateItems[c].dispose(),b.stateItems.splice(c,1))}),c.utils.arrayForEach(d,function(a){var c=o(f,a.value,b.comparefn),d=new q(b,a.value);f.splice(c,0,d.inputItem),b.stateItems.splice(c,0,d)}),this.outputObservable.valueHasMutated()}},t.prototype.appendToEntry=function(a,b,c){var d=a[b];d||(d=a[b]=[]),d.push(c)},t.prototype.removeFromEntry=function(a,b,c){var d=a[b];if(d){var e=d.indexOf(c);-1!==e&&(1===d.length?delete a[b]:d.splice(e,1))}},t.prototype.insertByKeyAndItem=function(a,b,c){this.appendToEntry(a,b,c)},t.prototype.removeByKeyAndItem=function(a,b,c){this.removeFromEntry(a,b,c)},t.prototype.addStateItemToIndex=function(a){var b=this.mapping(a.inputItem);this.appendToEntry(this.stateItems,b,a)},t.prototype.findStateItem=function(a){var b=this.ko,c=this.mapping(a),d=this.stateItems[c];if(!d)return null;var e=b.utils.arrayFilter(d,function(b){return b.inputItem===a});return e[0]||null},t.prototype.removeStateItem=function(a){var b=a.mappedValueComputed();this.removeFromEntry(this.stateItems,b,a),a.dispose()},t.prototype.addToIndex=function(a){var b=this.mapping(a),c=this.outputObservable.peek();this.insertByKeyAndItem(c,b,a);var d=new u(this,a);this.addStateItemToIndex(d)},t.prototype.removeItem=function(a){var b=this.findStateItem(a);if(b){var c=b.mappedValueComputed(),d=this.outputObservable.peek();this.removeByKeyAndItem(d,c,a),this.removeStateItem(b)}},t.prototype.onStructuralChange=function(a){var b=this;if(a.length){var c=this.ko,d=[],e=[];c.utils.arrayForEach(a,function(a){if("number"!=typeof a.moved)switch(a.status){case"added":d.push(a);break;case"deleted":e.push(a)}}),c.utils.arrayForEach(e,function(a){b.removeItem(a.value,a.index)}),c.utils.arrayForEach(d,function(a){b.addToIndex(a.value,a.index)}),this.outputObservable.valueHasMutated()}},u.prototype.dispose=function(){var a=this.mappedValueComputed();this.mappedValueComputed.dispose(),this.projection.options.disposeItem&&this.projection.options.disposeItem(a)},u.prototype.mappingEvaluator=function(){return this.projection.mapping(this.inputItem)},u.prototype.onMappingResultChanged=function(a){if(a!==this.previousMappedValue){var b=this.projection,c=b.outputObservable.peek();b.removeByKeyAndItem(c,this.previousMappedValue,this.inputItem),b.removeByKeyAndItem(b.stateItems,this.previousMappedValue,this),b.insertByKeyAndItem(c,a,this.inputItem),b.addStateItemToIndex(this),this.previousMappedValue=a}},b(v.prototype,t.prototype),v.prototype.insertByKeyAndItem=function(a,b,c){if(b in a)throw new Error("Unique indexes requires items must map to different keys");a[b]=c},v.prototype.removeByKeyAndItem=function(a,b){delete a[b]},v.prototype.addStateItemToIndex=function(a){var b=a.mappedValueComputed();b in this.stateItems&&this.stateItems[b].dispose(),this.stateItems[b]=a},v.prototype.findStateItem=function(a){var b=this.mapping(a);return this.stateItems[b]||null},v.prototype.removeStateItem=function(a){var b=a.mappedValueComputed();this.stateItems[b]===a&&delete this.stateItems[b],a.dispose()},v.prototype.addToIndex=function(a){var b=this.mapping(a),c=this.outputObservable.peek();this.insertByKeyAndItem(c,b,a);var d=new w(this,a);this.addStateItemToIndex(d)},v.prototype.removeItem=function(a){var b=this.findStateItem(a);if(b){var c=b.mappedValueComputed(),d=this.outputObservable.peek();this.removeByKeyAndItem(d,c,a),this.removeStateItem(b)}},b(w.prototype,u.prototype);var E="_ko.projections.cache";C()}(this);
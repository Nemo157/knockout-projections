/*! Knockout projections plugin - version 1.3.1
------------------------------------------------------------------------------
Copyright (c) Microsoft Corporation
All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0
THIS CODE IS PROVIDED *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE, MERCHANTABLITY OR NON-INFRINGEMENT.
See the Apache Version 2.0 License for specific language governing permissions and limitations under the License.
------------------------------------------------------------------------------
*/
!function(a){"use strict";function b(a){var b=Array.prototype.slice.call(arguments,1);return b.forEach(function(b){if(b)for(var c in b)a[c]=b[c]}),a}function c(a,b,c,d,e,f,g){this.inputItem=b,this.stateArrayIndex=c,this.mappingOptions=e,this.arrayOfState=f,this.outputObservableArray=g,this.outputArray=this.outputObservableArray.peek(),this.isIncluded=null,this.suppressNotification=!1,this.outputArrayIndex=a.observable(d),this.disposeFuncFromMostRecentMapping=null,this.mappedValueComputed=a.computed(this.mappingEvaluator,this),this.mappedValueComputed.subscribe(this.onMappingResultChanged,this),this.previousMappedValue=this.mappedValueComputed.peek()}function d(a,b){if(!a)return null;switch(a.status){case"added":return a.index;case"deleted":return a.index+b;default:throw new Error("Unknown diff status: "+a.status)}}function e(a,b,d,e,f,g,h,i,j){var k="number"==typeof b.moved,l=k?d[b.moved]:new c(a,b.value,e,f,g,h,i);return h.splice(e,0,l),l.isIncluded&&j.splice(f,0,l.mappedValueComputed.peek()),k&&(l.stateArrayIndex=e,l.setOutputArrayIndexSilently(f)),l}function f(a,b,c,d,e){var f=b.splice(c,1)[0];f.isIncluded&&e.splice(d,1),"number"!=typeof a.moved&&f.dispose()}function g(a,b,c){return a.stateArrayIndex=b,a.setOutputArrayIndexSilently(c),c+(a.isIncluded?1:0)}function h(a,b){for(var c={},d=0;d<a.length;d++){var e=a[d];"added"===e.status&&"number"==typeof e.moved&&(c[e.moved]=b[e.moved])}return c}function i(a,b,c){return c.length&&b[a.index]?b[a.index].outputArrayIndex.peek():c.length}function j(a,b,c,j,k,l){return b.subscribe(function(b){if(b.length){k.valueWillMutate();for(var m=h(b,c),n=0,o=b[0],p=0,q=o&&i(o,c,j),r=o.index;o||r<c.length;r++)if(d(o,p)===r){switch(o.status){case"added":var s=e(a,o,m,r,q,l,c,k,j);s.isIncluded&&q++,p++;break;case"deleted":f(o,c,r,q,j),p--,r--;break;default:throw new Error("Unknown diff status: "+o.status)}n++,o=b[n]}else r<c.length&&(q=g(c[r],r,q));k.valueHasMutated()}},null,"arrayChange")}function k(a,b){var d=this,e=[],f=[],g=a.observableArray(f),h=d.peek();if("function"==typeof b&&(b={mapping:b}),b.mappingWithDisposeCallback){if(b.mapping||b.disposeItem)throw new Error("'mappingWithDisposeCallback' cannot be used in conjunction with 'mapping' or 'disposeItem'.")}else if(!b.mapping)throw new Error("Specify either 'mapping' or 'mappingWithDisposeCallback'.");for(var i=0;i<h.length;i++){var k=h[i],l=new c(a,k,i,f.length,b,e,g),m=l.mappedValueComputed.peek();e.push(l),l.isIncluded&&f.push(m)}var n=j(a,d,e,f,g,b),o=a.pureComputed(g).extend({trackArrayChanges:!0}),p=o.dispose;return o.dispose=function(){n.dispose(),a.utils.arrayForEach(e,function(a){a.dispose()}),p.call(this,arguments)},C(a,o),o}function l(a,b){return k.call(this,a,function(a){return b(a)?a:F})}function m(a,b){var c=t.Descending;Array.isArray(a)||(a=[a],b=[b]);for(var d,e,f=0;f<a.length;f+=1){if(d=a[f],e=b[f],a instanceof c){if(!(b instanceof c))return!1;d=d.value,e=e.value}if(d!==e)return!1}return!0}function n(a,b){var c=t.Descending;Array.isArray(a)||(a=[a],b=[b]);for(var d,e,f=0;f<a.length;f+=1)if(d=a[f],e=b[f],d instanceof c){if(d.value>e.value)return-1;if(d.value<e.value)return 1}else{if(e>d)return-1;if(d>e)return 1}return 0}function o(a){var b=t.Descending;return function(c,d){var e=a(c,b.create),f=a(d,b.create);return n(e,f)}}function p(a,b,c){for(var d,e=-1,f=a.length;f-e>1;){d=e+f>>>1;var g=c(a[d],b);if(0>g)e=d;else if(f=d,!g)break}return f===a.length||c(a[f],b)?-f-1:f}function q(a,b,c){for(var d,e=-1,f=a.length;f-e>1;)d=e+f>>>1,c(a[d],b)<0?e=d:f=d;return f}function r(a,b,c){var d=p(a,b,c);if(0>d||a.length<=d||0!==c(a[d],b))return-1;for(var e=d;d-1>=0&&0===c(a[d-1],b);)d-=1;for(;e>=d;){if(a[d]===b)return d;d+=1}for(;d<a.length;){if(0!==c(a[d],b))return-1;if(a[d]===b)return d;d+=1}return-1}function s(a,b){var c=a.ko;this.projection=a,this.inputItem=b,this.mappedValueComputed=c.pureComputed(this.mappingEvaluator,this),this.mappedValueComputed.subscribe(this.onMappingResultChanged,this),this.previousMappedValue=this.mappedValueComputed.peek()}function t(a,b,c){var d=this;this.ko=a,this.options=c,this.mapping=c.mapping,this.comparefn=o(this.mapping),this.outputObservable=a.observable([].concat(b.peek()).sort(this.comparefn)),this.stateItems=a.utils.arrayMap(this.outputObservable.peek(),function(a){return new s(d,a)});var e=b.subscribe(this.onStructuralChange,this,"arrayChange");this.output=a.pureComputed(this.outputObservable).extend({trackArrayChanges:!0});var f=this.output.dispose;this.output.dispose=function(){e.dispose(),a.utils.arrayForEach(d.stateItems,function(a){a.dispose()}),f.call(this,arguments)},C(a,this.output)}function u(a,b){"function"==typeof b&&(b={mapping:b});var c=new t(a,this,b);return c.output}function v(a,b,c){var d=this;this.ko=a,this.options=c,this.outputObservable=a.observable({}),this.stateItems={},this.mapping=function(a){return[].concat(c.mapping(a))};for(var e=b.peek(),f=0;f<e.length;f+=1)this.addToIndex(e[f],f);var g=b.subscribe(this.onStructuralChange,this,"arrayChange");this.output=a.pureComputed(this.outputObservable);var h=this.output.dispose;this.output.dispose=function(){g.dispose();for(var a in d.stateItems)d.stateItems.hasOwnProperty(a)&&d.stateItems[a].dispose();h.call(this,arguments)}}function w(a,b){this.projection=a,this.inputItem=b,this.mappedValueComputed=a.ko.pureComputed(this.mappingEvaluator,this),this.mappedValueComputed.subscribe(this.onMappingResultChanged,this),this.previousMappedValue=this.mappedValueComputed.peek()}function x(a,b,c){v.call(this,a,b,c)}function y(a,b){w.call(this,a,b)}function z(a,b){"function"==typeof b&&(b={mapping:b,unique:!1});var c=b.unique?new x(a,this,b):new v(a,this,b);return c.output}function A(a,b){"function"==typeof b&&(b={mapping:b}),b.unique=!0;var c=new x(a,this,b);return c.output}function B(a){function b(a,b){return function(){return b.apply(this,[a].concat(Array.prototype.slice.call(arguments,0)))}}a[G]={map:b(a,k),sortBy:b(a,u),indexBy:b(a,z),uniqueIndexBy:b(a,A),filter:b(a,l)}}function C(a,b){return a.utils.extend(b,a[G]),b}function D(a){a.projections={_exclusionMarker:F},B(a),C(a,a.observableArray.fn)}function E(){if("undefined"!=typeof module&&"undefined"!=typeof module.exports){var b=require("knockout");D(b),module.exports=b}else"function"==typeof define&&define.amd?define(["knockout"],D):"ko"in a&&D(a.ko)}var F={};c.prototype.dispose=function(){this.mappedValueComputed.dispose(),this.disposeResultFromMostRecentEvaluation()},c.prototype.disposeResultFromMostRecentEvaluation=function(){if(this.disposeFuncFromMostRecentMapping&&(this.disposeFuncFromMostRecentMapping(),this.disposeFuncFromMostRecentMapping=null),this.mappingOptions.disposeItem){var a=this.mappedValueComputed();this.mappingOptions.disposeItem(a)}},c.prototype.mappingEvaluator=function(){null!==this.isIncluded&&this.disposeResultFromMostRecentEvaluation();var a;if(this.mappingOptions.mapping)a=this.mappingOptions.mapping(this.inputItem,this.outputArrayIndex);else{if(!this.mappingOptions.mappingWithDisposeCallback)throw new Error("No mapping callback given.");var b=this.mappingOptions.mappingWithDisposeCallback(this.inputItem,this.outputArrayIndex);if(!("mappedValue"in b))throw new Error("Return value from mappingWithDisposeCallback should have a 'mappedItem' property.");a=b.mappedValue,this.disposeFuncFromMostRecentMapping=b.dispose}var c=a!==F;return this.isIncluded!==c&&(null!==this.isIncluded&&this.moveSubsequentItemsBecauseInclusionStateChanged(c),this.isIncluded=c),a},c.prototype.onMappingResultChanged=function(a){a!==this.previousMappedValue&&(this.suppressNotification||this.outputObservableArray.valueWillMutate(),this.isIncluded&&this.outputArray.splice(this.outputArrayIndex.peek(),1,a),this.suppressNotification||this.outputObservableArray.valueHasMutated(),this.previousMappedValue=a)},c.prototype.moveSubsequentItemsBecauseInclusionStateChanged=function(a){var b,c,d=this.outputArrayIndex.peek();if(a)for(this.outputArray.splice(d,0,null),b=this.stateArrayIndex+1;b<this.arrayOfState.length;b++)c=this.arrayOfState[b],c.setOutputArrayIndexSilently(c.outputArrayIndex.peek()+1);else for(this.outputArray.splice(d,1),b=this.stateArrayIndex+1;b<this.arrayOfState.length;b++)c=this.arrayOfState[b],c.setOutputArrayIndexSilently(c.outputArrayIndex.peek()-1)},c.prototype.setOutputArrayIndexSilently=function(a){this.suppressNotification=!0,this.outputArrayIndex(a),this.suppressNotification=!1},s.prototype.dispose=function(){var a=this.mappedValueComputed();this.mappedValueComputed.dispose(),this.projection.options.disposeItem&&this.projection.options.disposeItem(a)},s.prototype.mappingEvaluator=function(){return this.projection.mapping(this.inputItem,t.Descending.create)},s.prototype.onMappingResultChanged=function(a){if(!m(a,this.previousMappedValue)){var b=this.projection,c=b.outputObservable,d=c.peek(),e=b.stateItems,f=r(e,this,o(function(a){return a.previousMappedValue}));if(e[f]===this){c.valueWillMutate(),d.splice(f,1),e.splice(f,1);var g=q(d,this.inputItem,b.comparefn);d.splice(g,0,this.inputItem),e.splice(g,0,this),this.previousMappedValue=a,c.valueHasMutated()}else{var h=b.ko;h.utils.arrayForEach(e,function(a){a.previousMappedValue=a.mappingEvaluator()}),e.sort(o(function(a){return a.previousMappedValue})),d=[],h.utils.arrayForEach(e,function(a){d.push(a.inputItem)}),c(d)}}},t.Descending=function(a){this.value=a},t.Descending.create=function(a){return new t.Descending(a)},t.prototype.onStructuralChange=function(a){if(a.length){this.outputObservable.valueWillMutate();var b=this,c=this.ko,d=[],e=[];c.utils.arrayForEach(a,function(a){if("number"!=typeof a.moved)switch(a.status){case"added":d.push(a);break;case"deleted":e.push(a)}});var f=this.outputObservable.peek();c.utils.arrayForEach(e,function(a){var c=r(f,a.value,b.comparefn);-1!==c&&(f.splice(c,1),b.stateItems[c].dispose(),b.stateItems.splice(c,1))}),c.utils.arrayForEach(d,function(a){var c=q(f,a.value,b.comparefn),d=new s(b,a.value);f.splice(c,0,d.inputItem),b.stateItems.splice(c,0,d)}),this.outputObservable.valueHasMutated()}},v.prototype.arraysEqual=function(a,b){var c=this.ko;if(a===b)return!0;if("undefined"==typeof a||"undefined"==typeof b)return!1;if(a.length!==b.length)return!1;for(var d=0;d<a.length;d+=1)if(c.observable.fn.equalityComparer&&c.isObservable(a[d])&&!c.observable.fn.equalityComparer(a[d],b[d])||a[d]!==b[d])return!1;return!0},v.prototype.appendToEntry=function(a,b,c){var d=a[b];d||(d=a[b]=[]),d.push(c)},v.prototype.removeFromEntry=function(a,b,c){var d=a[b];if(d){var e=d.indexOf(c);-1!==e&&(1===d.length?delete a[b]:d.splice(e,1))}},v.prototype.insertByKeyAndItem=function(a,b,c){this.appendToEntry(a,b,c)},v.prototype.removeByKeyAndItem=function(a,b,c){this.removeFromEntry(a,b,c)},v.prototype.addStateItemToIndex=function(a){var b=this.mapping(a.inputItem)[0];this.appendToEntry(this.stateItems,b,a)},v.prototype.findStateItem=function(a){var b=this.ko,c=this.mapping(a)[0],d=this.stateItems[c];if(!d)return null;var e=b.utils.arrayFilter(d,function(b){return b.inputItem===a});return e[0]||null},v.prototype.removeStateItem=function(a){var b=a.mappedValueComputed()[0];this.removeFromEntry(this.stateItems,b,a),a.dispose()},v.prototype.addToIndex=function(a){var b=this,c=this.ko,d=this.mapping(a),e=this.outputObservable.peek();c.utils.arrayForEach(d,function(c){b.insertByKeyAndItem(e,c,a)});var f=new w(this,a);this.addStateItemToIndex(f)},v.prototype.removeItem=function(a){var b=this,c=this.ko,d=this.findStateItem(a);if(d){var e=d.mappedValueComputed(),f=this.outputObservable.peek();c.utils.arrayForEach(e,function(c){b.removeByKeyAndItem(f,c,a)}),this.removeStateItem(d)}},v.prototype.onStructuralChange=function(a){var b=this;if(a.length){var c=this.ko,d=[],e=[];c.utils.arrayForEach(a,function(a){if("number"!=typeof a.moved)switch(a.status){case"added":d.push(a);break;case"deleted":e.push(a)}}),c.utils.arrayForEach(e,function(a){b.removeItem(a.value,a.index)}),c.utils.arrayForEach(d,function(a){b.addToIndex(a.value,a.index)}),this.outputObservable.valueHasMutated()}},w.prototype.dispose=function(){var a=this.mappedValueComputed();this.mappedValueComputed.dispose(),this.projection.options.disposeItem&&this.projection.options.disposeItem(a)},w.prototype.mappingEvaluator=function(){return this.projection.mapping(this.inputItem)},w.prototype.onMappingResultChanged=function(a){var b=this.projection;if(!b.arraysEqual(this.newValue,this.previousMappedValue)){var c=b.outputObservable,d=c.peek();c.valueWillMutate(),b.removeByKeyAndItem(d,this.previousMappedValue,this.inputItem),b.removeByKeyAndItem(b.stateItems,this.previousMappedValue,this),b.insertByKeyAndItem(d,a,this.inputItem),b.addStateItemToIndex(this),this.previousMappedValue=a,c.valueHasMutated()}},b(x.prototype,v.prototype),x.prototype.insertByKeyAndItem=function(a,b,c){if(b in a)throw new Error("Unique indexes requires items must map to different keys; duplicate key: "+b);a[b]=c},x.prototype.removeByKeyAndItem=function(a,b){delete a[b]},x.prototype.addStateItemToIndex=function(a){var b=a.mappedValueComputed()[0];this.stateItems[b]=a},x.prototype.findStateItem=function(a){var b=this.mapping(a)[0];return this.stateItems[b]||null},x.prototype.removeStateItem=function(a){var b=a.mappedValueComputed()[0];this.stateItems[b]===a&&delete this.stateItems[b],a.dispose()},x.prototype.addToIndex=function(a){var b=this,c=this.ko,d=this.mapping(a),e=this.outputObservable.peek();c.utils.arrayForEach(d,function(c){b.insertByKeyAndItem(e,c,a)});var f=new y(this,a);this.addStateItemToIndex(f)},x.prototype.removeItem=function(a){var b=this,c=this.ko,d=this.findStateItem(a);if(d){var e=d.mappedValueComputed(),f=this.outputObservable.peek();c.utils.arrayForEach(e,function(c){b.removeByKeyAndItem(f,c,a)}),this.removeStateItem(d)}},b(y.prototype,w.prototype);var G="_ko.projections.cache";E()}(this);